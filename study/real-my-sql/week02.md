# 06 데이터 압축

## 6.0 데이터 압축

- 디스크에 저장된 데이터 파일의 크기는 (1. 쿼리 처리 성능)과 (2. 백업 및 복구 시간)과 밀접하게 연결된다
  - 쿼리 처리성능: 데이터 파일이 크면 쿼리를 처리하기 위해 **더 많은 데이터 페이지를** InnoDB 버퍼풀로 읽어야 할 수도 있고,
    더티페이지가 **더 자주** 디스크로 기록돼야 한다.
  - 백업과 복구: 데이터 파일이 크면 백업 시간이 오래 걸리고, 복구 시간도 오래 걸린다
  - 결론: 이런 문제점을 해결하기 위해 **데이터압축 기능**을 사용
- MySQL 서버에서 사용 가능한 압축 방식은 (1. 테이블 압축)과 (2. 페이지 압축)이 있다

## 6.1 페이지 압축

- 페이지 압축: Transparent Page Compression
  - 페이지 압축은 디스크에 저장하는 시점에 데이터 페이지가 압축되고,
    디스크에서 데이터 페이지를 읽어올 때 압축이 해제된다
- 책의 페이지 압축 설명은 알아듣지 못하겠어서 생략한다
- 실제 페이지 압축은 많이 사용되지 않는다
  (1.MySQL의 페이지압축은 특정 버전의 운영체제과 하드웨어 자체가 펀치홀 기능을 지원해야하는 점)과
  (2.파일 시스템 관련 명령어(유틸리티)가 펀치홀을 지원하지 않는다)

## 6.2 테이블 압축

- 테이블 압축: (페이지 압축과 다르게) 운영체제나 하드웨어에 대한 제약이 없다
- 테이블 압축의 장점과 단점
  - 장점: 디스크의 데이터 파일 크기를 줄일 수 있다
  - 단점: (1. 버퍼풀 공간 활용률이 낮음), (2. 쿼리 처리 성능이 낮음), (3. 빈번한 데이터 변경시 압축률이 떨어짐)

### 6.2.1 압축 테이블 생성

- 압축 테이블 생성 조건
  - 테이블이 별도의 테이블 스페이스를 사용하도록 한다 -> `innodb_file_per_table` 시스템 변수를 `ON`으로 설정
  - 테이블을 생성할 때 `ROW_FORMAT=COMPRESSED` 옵션을 명시한다
  - `KEY_BLOCK_SIZE` 옵션을 이용해 압축된 페이지가 저장될 페이지의 크기를 지정한다
- 테이블 압축 방식
  - 원본 데이터 페이지의 압축 결과가 목표크기(`KEY_BLOCK_SIZE`)보다 작거나 같을 때까지 반복해서 스플릿을 하고 압축을 시도한다
    - 목표 크기가 잘못 설정되면 MySQL 서버의 처리 성능이 급격히 떨어질 수 있다 -> 버퍼풀에서 디스크로 기록되기 전에 압축하는 과정에 시간이 오래 걸리게 된다

### 6.2.2 KEY_BLOCK_SIZE 결정

- 테이블 압축에서 가장 중요한 부분은 압축된 결과가 어느정도 될지 예측해서 **`KEY_BLOCK_SIZE`를 결정하는 것이다**
  - 솔루션: `KEY_BLOCK_SIZE`를 4KB 또는 8KB로 테이블을 생성해서 샘플 데이터를 저장해보고 적절한지 판단한다
    이때 샘플 데이터가 많으면 많을 수록 정확한 테스트가 가능하다. 최소한 테이블의 데이터 페이지가 10개 정도는 되도록 데이터를 생성한다
