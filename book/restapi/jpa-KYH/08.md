# 자바 ORM 표준 JPA 프로그래밍

## 프록시와 즉시로딩, 지연로딩

- 객체가 데이터베이스에 저장되어 있으므로 연관된 객체를 탐색하기 어렵다
- 프록시를 사용하면 연관된 객체를 처음부터 데이터베이스에서 조회하는 것이 아니라,  
  실제 사용하는 시점에 데이터베이스에서 조회한다
- 자주 함께 사용하는 객체들은 조인을 사용해 함께 조회하는 것이 효과적이다

## 영속성 전이와 고아 객체

- JPA 는 연관된 객체를 함께 저장하거나 함께 삭제할 수 있는 영속성 전이와 고아 객체 제거라는 기능을 제공한다

## 프록시

- 지연로딩: JPA 는 엔티티가 실제 사용될 때까지 데이터베이스에서 조회를 지연하는 방법
- 프록시 객체: 실제 엔티티 객체 대신 데이터베이스 조회를 지연하는 가짜 객체

## 프록시 기초

- `EntityManager.find()`: 영속성 컨텍스트에 엔티티가 없으면 데이터베이스를 조회한다
- `EntityManager.getReference()`: 데이터 접근을 위임한 프록시 객체를 반환한다
  - 엔티티가 실제 사용되는 시점까지 데이터베이스 조회를 미룬다
  - 영속성 컨텍스트에 해당 엔티티가 이미 있으면 실제 엔티티를 반환한다
- 프록시 객체 초기화: 실제 사용될 때 데이터베이스를 조회해서 실제 엔티티 객체를 생성하는 것

## 프록시와 식별자

- 엔티티를 프록시로 조회할 때 (`EntityManager.getReference()`) 식별자(PK) 값을 파라미터로 전달한다
  - 프록시 객체가 이 식별자 값을 보관한다

## 프록시 확인

- `PersistenceUnitUtil.isLoaded(Object entity)` 를 사용하면 프록시 인스턴스의 초기화 여부를 알 수 있다

## 즉시로딩과 지연로딩

- 즉시로딩: 엔티티를 조회할 때 연관된 엔티티도 함께 조회
  - 설정방법: `@ManyToOne(fetch = FetchType.EAGER)`
  - 즉시로딩을 최적화하기 위해 가능하면 조인 쿼리를 사용
- 지연로딩: 연관된 엔티티를 실제 사용할 때 조회
  - 설정방법: `@ManyToOne(fetch = FetchType.LAZY)`
  - 조회 대상이 영속성 컨텍스트에 이미 있으면 프록시가 아닌 실제객체 사용

## nullable 설정에 따른 조인 전략

- `@JoinColumn(nullable = true)`: NULL 허용(기본값), 외부 조인 사용
- `@JoinColumn(nullable = false)`: NULL 허용하지 않음, 내부 조인 사용

## 즉시로딩, 지연로딩 정리

- 연관된 엔티티를 즉시 로딩하는 것이 좋은지 아니면 실제 사용할 때까지 지연해서 로딩하는 것이 좋은지는 상황에 따라 다르다

## 프록시와 컬렉션 래퍼

- 컬렉션래퍼: 엔티티에 컬렉션이 있으면 컬렉션을 추적하고 관리할 목적으로 원본 컬렉션을 하이버네이트가 제공하는 내장 컬렉션으로 변경한다
- 컬렉션은 컬렉션 래퍼가 지연로딩을 처리해준다
- 컬렉션에서 실제 데이터를 조회할 때 데이터베이스에서 조회

## JPA 기본 페치 전략

- `@ManyToOne`, `@OneToOne`: 즉시로딩(`FetchType.EAGER`)
  - 연관된 엔티티가 하나면 즉시로딩
- `@OneToMany`, `@ManyToMany`: 지연로딩(`FetchType.LAZY`)
  - 컬렉션이면 지연로딩
- 추천방식: 모든 연관관계에 지연로딩을 사용하고 실제 사용하는 상황을 보고 꼭 필요한 곳에만 즉시로딩 적용

## 컬렉션에 FetchType.EAGER 사용시 주의점

- 컬렉션을 하나 이상 즉시로딩하는 것은 권장하지 않는다
  - 너무 많은 데이터를 반환할 수 있다. JPA 는 이렇게 조회된 결과를 메모리에서 필터링해서 반환
- 컬렉션 즉시 로딩은 항상 외부 조인을 사용한다
- `@ManyToOne`, `@OneToOne`
  - (optional = false): 내부조인
  - (optional = true):외부 조인

## 영속성 전이: CASCADE

- 특정 엔티티를 영속 상태로 만들 때 연관된 엔티티도 함께 영속 상태로 만들고 싶으면 영속성 전이기능(transitive persistence)을 사용한다
  - JPA는 CASCADE 옵션으로 영속성 전이를 제공한다

## 영속성 전이: 저장

- `@OneToMany(mappedBy = "parent", cascade = CascadeType.PERSIST)`
  - 부모를 영속화할 때 연관된 자식들도 함께 영속화하라는 옵션

## 고아객체

- 고아객체제거: 부모 엔티티와 연관관계가 끊어진 자식 엔티티를 자동으로 삭제하는 기능
- 부모 엔티티의 컬렉션에서 자식 엔티티의 참조만 제거하면 자식 엔티티가 자동으로 삭제
