# 자바 ORM 표준 JPA 프로그래밍

## 엔티티 매핑

- 엔티티와 테이블을 정확히 매핑하는 것이 중요하다

## 매핑 어노테이션

- 객체와 테이블 매핑: `@Entity`, `@Table`
- 기본키 매핑: `@Id`
- 필드와 칼럼매핑: `@Column`
- 연관관계 매핑: `@ManyToOne`, `@JoinColumn`

## `@Entity`

- 속성(name): 엔티티 이름 지정 (기본값: 클래스이름)
- 기본생성자는 필수다 (`public` 또는 `protected`)
  - JPA 는 기본생성자를 이용해서 엔티티 객체를 만든다
- `final` 클래스, `enum`, `interface`, `inner` 클래스에는 사용할 수 없다
- 저장할 필드(`@Column`) 에 `final`을 사용하면 안된다

## `@Table`

- 속성(name): 매핑할 테이블 이름 (기본값: 엔티티 이름)

## 기본키 매핑

- `@Id` 만 사용하면 기본키를 직접 할당하고, `@Id`에 `@GeneratedValue` 를 추가하면 원하는 키 생성 전략을 선택할 수 있다

### 키 생성 전략

- `SEQUENCE` 나 `IDENTITY` 전략은 사용하는 데이터베이스에 의존한다
- 기본 키 직접 할당전략은 `em.persist()`로 엔티티 저장하기 전에 기본키를 직접 할당하는 방법

## `IDENTITY` 전략

- `IDENTITY` 전략은 기본 키 생성을 데이터베이스에 위임하는 전략
- 엔티티가 영속 상태가 되려면 식별자가 반드시 필요하다.
  따라서 `em.persist()`를 호출하는 즉시 `INSERT SQL`이 데이터베이스에 전달된다.

## `SEQUENCE` 전략

- 데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 데이터베이스 오브젝트
- 1. 데이터베이스 시퀀스를 사용해서 식별자를 조회한다. 2. 조회한 식별자를 할당한 후 엔티티를 영속성 컨텍스트에 저장
- `@SequenceGenerator.allocationSize`: 설정한 값만큼 한 번에 시퀀스 값을 증가시키고 그만큼 메모리에 시퀀스 값을 할당

## 기본키 매핑정리

### `em.persist()`를 호출한 뒤 발생하는 일들

- 직접할당: `em.persist()`를 호출 전에 직접 식별자값을 할당해야한다
- `SEQUENCE`: 데이터베이스 시퀀스에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다
- `TABLE`: 데이터베이스 시퀀스 생성용 테이블에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다
- `IDENTTY`: 데이터베이스에 엔티티를 저장해서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다

### (권고) 식별자 선택전략

- 기본키 조건: null값 허용 X, 유일해야하며, 변해서는 안된다
- JPA는 모든 엔티티에 일관된 방식으로 대리 키 사용을 권장
