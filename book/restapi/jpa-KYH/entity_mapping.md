# 자바 ORM 표준 JPA 프로그래밍

## 엔티티 매핑

- 엔티티와 테이블을 정확히 매핑하는 것이 중요하다

## 매핑 어노테이션

- 객체와 테이블 매핑: `@Entity`, `@Table`
- 기본키 매핑: `@Id`
- 필드와 칼럼매핑: `@Column`
- 연관관계 매핑: `@ManyToOne`, `@JoinColumn`

## `@Entity`

- 속성(name): 엔티티 이름 지정 (기본값: 클래스이름)
- 기본생성자는 필수다 (`public` 또는 `protected`)
  - JPA 는 기본생성자를 이용해서 엔티티 객체를 만든다
- `final` 클래스, `enum`, `interface`, `inner` 클래스에는 사용할 수 없다
- 저장할 필드(`@Column`) 에 `final`을 사용하면 안된다

## `@Table`

- 속성(name): 매핑할 테이블 이름 (기본값: 엔티티 이름)

## 기본키 매핑

- `@Id` 만 사용하면 기본키를 직접 할당하고, `@Id`에 `@GeneratedValue` 를 추가하면 원하는 키 생성 전략을 선택할 수 있다

### 키 생성 전략

- `SEQUENCE` 나 `IDENTITY` 전략은 사용하는 데이터베이스에 의존한다
- 기본 키 직접 할당전략은 `em.persist()`로 엔티티 저장하기 전에 기본키를 직접 할당하는 방법

## `IDENTITY` 전략

- `IDENTITY` 전략은 기본 키 생성을 데이터베이스에 위임하는 전략
- 엔티티가 영속 상태가 되려면 식별자가 반드시 필요하다.
  따라서 `em.persist()`를 호출하는 즉시 `INSERT SQL`이 데이터베이스에 전달된다.

## `SEQUENCE` 전략

- 데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 데이터베이스 오브젝트
- 1. 데이터베이스 시퀀스를 사용해서 식별자를 조회한다. 2. 조회한 식별자를 할당한 후 엔티티를 영속성 컨텍스트에 저장
- `@SequenceGenerator.allocationSize`: 설정한 값만큼 한 번에 시퀀스 값을 증가시키고 그만큼 메모리에 시퀀스 값을 할당

## 기본키 매핑정리

### `em.persist()`를 호출한 뒤 발생하는 일들

- 직접할당: `em.persist()`를 호출 전에 직접 식별자값을 할당해야한다
- `SEQUENCE`: 데이터베이스 시퀀스에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다
- `TABLE`: 데이터베이스 시퀀스 생성용 테이블에서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다
- `IDENTTY`: 데이터베이스에 엔티티를 저장해서 식별자 값을 획득한 후 영속성 컨텍스트에 저장한다

### (권고) 식별자 선택전략

- 기본키 조건: null값 허용 X, 유일해야하며, 변해서는 안된다
- JPA는 모든 엔티티에 일관된 방식으로 대리 키 사용을 권장

---

## 연관관계

- `@JoinColumn`: 외래 키를 매핑할 때 사용
  - 속성(name): 매핑할 외래 키 이름 (기본값:필드명(`@ManyToOne`)+`_`+참조하는 테이블의 컬럼명)
- `@ManyToOne`: 다대일 관계에서 사용

### 저장

- 엔티티 저장시 연관된 모든 엔티티는 영속 상태여야 한다.
- JPA 는 참조 객체의 식별자를 외래키로 사용해서 등록 쿼리를 생성한다

### 조회

- 연관관계가 있는 엔티티를 조회하는 방법
  - 객체그래프탐색: 객체를 통한 조회
  - 객체지향쿼리사용: 연관관계 필드를 통해 조인하여 검색

### 제거

- 연관관계를 `null`로 설정
- 연관된 엔티티를 삭제하려면 기존에 있던 연관관계를 먼저 제거하고 삭제 (외래키제약조건)

## 연관관계 주인

- 엔티티를 양방향 연관관계에서 **객체의 참조는 둘**인데 **테이블의 외래키는 하나**이다  
  두 객체 연관관계 중 하나를 정해 테이블의 외래키를 관리해주어야 한다
- 연관관계 주인만이 데이터베이스 연관관계와 매핑되고 외래키를 관리(등록, 수정, 삭제할 수 있다)  
  반면 주인이 아닌 쪽은 읽기만 할 수 있다
- 주인은 `mappedBy` 속성을 사용하지 않는다  
  주인이 아니면 `mappedBy` 속성으로 속성의 값으로 연관관계의 주인을 지정한다
- 연관관계 주인이란 **외래키 관리자**를 선택하는 것
- 객체 양쪽 방향에 모두 값을 입력해주는 것이 안전하다

## 연관관계 기초 정리

- 단방향 매핑만으로 테이블과 객체의 연관관계 매핑은 완료
- 단방향을 양방향으로 만들면 반대방향으로 **객체 그래프 탐색기능**이 추가
- 양방향 연관관계를 매핑하면 객체에서 양쪽 방향 모두 관리

### 결론과 주의사항

- 단뱡향 매핑을 사용하고 반대방향으로 **객체 탐색기능** 또는 **JPQL쿼리탐색**이 필요하면 양방향을 사용
- 무한루프 주의 (e.g. `toString()`)
